(function(c){c.fn.markItUp=function(h,l){var b,g,j,r;g=j=r=!1;b={id:"",nameSpace:"",root:"",previewHandler:!1,previewInWindow:"",previewAutoRefresh:!0,previewPosition:"after",previewTemplatePath:"~/templates/preview.html",previewParser:!1,previewParserPath:"",previewParserVar:"data",resizeHandle:!0,beforeInsert:"",afterInsert:"",onEnter:{},onShiftEnter:{},onCtrlEnter:{},onTab:{},markupSet:[{}]};c.extend(b,h,l);b.root||c("script").each(function(g,j){miuScript=c(j).get(0).src.match(/(.*)jquery\.markitup(\.pack)?\.js$/);
null!==miuScript&&(b.root=miuScript[1])});return this.each(function(){function l(a,c){return c?a.replace(/("|')~\//g,"$1"+b.root):a.replace(/^~\//,b.root)}function h(a){var i=c("<ul></ul>"),b=0;c("li:hover > ul",i).css("display","block");c.each(a,function(){var a=this,d="",f,g;f=a.key?(a.name||"")+" [Ctrl+"+a.key+"]":a.name||"";key=a.key?'accesskey="'+a.key+'"':"";if(a.separator)d=c('<li class="markItUpSeparator">'+(a.separator||"")+"</li>").appendTo(i);else{b++;for(g=t.length-1;0<=g;g--)d+=t[g]+
"-";d=c('<li class="markItUpButton markItUpButton'+d+b+" "+(a.className||"")+'"><a href="" '+key+' title="'+f+'">'+(a.name||"")+"</a></li>").bind("contextmenu.markItUp",function(){return!1}).bind("click.markItUp",function(){return!1}).bind("focusin.markItUp",function(){e.focus()}).bind("mouseup",function(){a.call&&eval(a.call)();setTimeout(function(){s(a)},1);return!1}).bind("mouseenter.markItUp",function(){c("> ul",this).show();c(document).one("click",function(){c("ul ul",v).hide()})}).bind("mouseleave.markItUp",
function(){c("> ul",this).hide()}).appendTo(i);a.dropMenu&&(t.push(b),c(d).addClass("markItUpDropMenu").append(h(a.dropMenu)))}});t.pop();return i}function m(a){c.isFunction(a)&&(a=a(p));a?(a=a.toString(),a=a.replace(/\(\!\(([\s\S]*?)\)\!\)/g,function(a,c){var b=c.split("|!|");return!0===r?void 0!==b[1]?b[1]:b[0]:void 0===b[1]?"":b[0]}),a=a.replace(/\[\!\[([\s\S]*?)\]\!\]/g,function(a,c){var b=c.split(":!:");if(!0===u)return!1;value=prompt(b[0],b[1]?b[1]:"");null===value&&(u=!0);return value})):a=
"";return a}function w(a){var c=m(n.openWith),b=m(n.placeHolder),d=m(n.replaceWith),e=m(n.closeWith),f=m(n.openBlockWith),g=m(n.closeBlockWith),l=n.multiline;if(""!==d)block=c+d+e;else if(""===selection&&""!==b)block=c+b+e;else{var a=a||selection,j=[a],k=[];!0===l&&(j=a.split(/\r?\n/));for(a=0;a<j.length;a++){line=j[a];var h;(h=line.match(/ *$/))?k.push(c+line.replace(/ *$/g,"")+e+h):k.push(c+line+e)}block=k.join("\n")}block=f+block+g;return{block:block,openWith:c,replaceWith:d,placeHolder:b,closeWith:e}}
function s(a){var i,h,o;p=n=a;x();c.extend(p,{line:"",root:b.root,textarea:d,selection:selection||"",caretPosition:f,ctrlKey:g,shiftKey:j,altKey:r});m(b.beforeInsert);m(n.beforeInsert);(!0===g&&!0===j||!0===a.multiline)&&m(n.beforeMultiInsert);c.extend(p,{line:1});if(!0===g&&!0===j){lines=selection.split(/\r?\n/);i=0;h=lines.length;for(o=0;o<h;o++)""!==c.trim(lines[o])?(c.extend(p,{line:++i,selection:lines[o]}),lines[o]=w(lines[o]).block):lines[o]="";string={block:lines.join("\n")};start=f;i=string.block.length+
(c.browser.opera?h-1:0)}else!0===g?(string=w(selection),start=f+string.openWith.length,i=string.block.length-string.openWith.length-string.closeWith.length,i-=string.block.match(/ $/)?1:0,i-=z(string.block)):!0===j?(string=w(selection),start=f,i=string.block.length,i-=z(string.block)):(string=w(selection),start=f+string.block.length,i=0,start-=z(string.block));""===selection&&""===string.replaceWith&&(k+=B(string.block),start=f+string.openWith.length,i=string.block.length-string.openWith.length-string.closeWith.length,
k=e.val().substring(f,e.val().length).length,k-=B(e.val().substring(0,f)));c.extend(p,{caretPosition:f,scrollPosition:y});string.block!==selection&&!1===u?(h=string.block,document.selection?document.selection.createRange().text=h:d.value=d.value.substring(0,f)+h+d.value.substring(f+selection.length,d.value.length),C(start,i)):k=-1;x();c.extend(p,{line:"",selection:selection});(!0===g&&!0===j||!0===a.multiline)&&m(n.afterMultiInsert);m(n.afterInsert);m(b.afterInsert);q&&b.previewAutoRefresh&&(b.previewHandler&&
"function"===typeof b.previewHandler?b.previewHandler(e.val()):b.previewParser&&"function"===typeof b.previewParser?(a=b.previewParser(e.val()),A(l(a,1))):""!==b.previewParserPath?c.ajax({type:"POST",dataType:"text",global:!1,url:b.previewParserPath,data:b.previewParserVar+"="+encodeURIComponent(e.val()),success:function(a){A(l(a,1))}}):F||c.ajax({url:b.previewTemplatePath,dataType:"text",global:!1,success:function(a){A(l(a,1).replace(/<\!-- content --\>/g,e.val()))}}));j=r=g=u=!1}function B(a){return c.browser.opera?
a.length-a.replace(/\n*/g,"").length:0}function z(a){return c.browser.msie?a.length-a.replace(/\r*/g,"").length:0}function C(a,b){if(d.createTextRange){if(c.browser.opera&&9.5<=c.browser.version&&0==b)return!1;range=d.createTextRange();range.collapse(!0);range.moveStart("character",a);range.moveEnd("character",b);range.select()}else d.setSelectionRange&&d.setSelectionRange(a,a+b);d.scrollTop=y;d.focus()}function x(){d.focus();y=d.scrollTop;if(document.selection)if(selection=document.selection.createRange().text,
c.browser.msie){var a=document.selection.createRange(),b=a.duplicate();b.moveToElementText(d);for(f=-1;b.inRange(a);)b.moveStart("character"),f++}else f=d.selectionStart;else f=d.selectionStart,selection=d.value.substring(f,d.selectionEnd);return selection}function A(a){if(q.document){try{sp=q.document.documentElement.scrollTop}catch(b){sp=0}q.document.open();q.document.write(a);q.document.close();q.document.documentElement.scrollTop=sp}}function D(a){j=a.shiftKey;r=a.altKey;g=!a.altKey||!a.ctrlKey?
a.ctrlKey||a.metaKey:!1;if("keydown"===a.type){if(!0===g&&(li=c('a[accesskey="'+String.fromCharCode(a.keyCode)+'"]',v).parent("li"),0!==li.length))return g=!1,setTimeout(function(){li.triggerHandler("mouseup")},1),!1;if(13===a.keyCode||10===a.keyCode){if(!0===g)return g=!1,s(b.onCtrlEnter),b.onCtrlEnter.keepDefault;if(!0===j)return j=!1,s(b.onShiftEnter),b.onShiftEnter.keepDefault;s(b.onEnter);return b.onEnter.keepDefault}if(9===a.keyCode){if(!0==j||!0==g||!0==r)return!1;if(-1!==k)return x(),k=e.val().length-
k,C(k,0),k=-1,!1;s(b.onTab);return b.onTab.keepDefault}}}var e,d,t,y,f,k,n,p,v,E,q,F,u;e=c(this);d=this;t=[];u=!1;y=f=0;k=-1;b.previewParserPath=l(b.previewParserPath);b.previewTemplatePath=l(b.previewTemplatePath);nameSpace=id="";b.id?id='id="'+b.id+'"':e.attr("id")&&(id='id="markItUp'+e.attr("id").substr(0,1).toUpperCase()+e.attr("id").substr(1)+'"');b.nameSpace&&(nameSpace='class="'+b.nameSpace+'"');e.wrap("<div "+nameSpace+"></div>");e.wrap("<div "+id+' class="markItUp"></div>');e.wrap('<div class="markItUpContainer"></div>');
e.addClass("markItUpEditor");v=c('<div class="markItUpHeader"></div>').insertBefore(e);c(h(b.markupSet)).appendTo(v);E=c('<div class="markItUpFooter"></div>').insertAfter(e);!0===b.resizeHandle&&!0!==c.browser.safari&&(resizeHandle=c('<div class="markItUpResizeHandle"></div>').insertAfter(e).bind("mousedown.markItUp",function(a){var b=e.height(),d=a.clientY,f,g;f=function(a){e.css("height",Math.max(20,a.clientY+b-d)+"px");return!1};g=function(){c("html").unbind("mousemove.markItUp",f).unbind("mouseup.markItUp",
g);return!1};c("html").bind("mousemove.markItUp",f).bind("mouseup.markItUp",g)}),E.append(resizeHandle));e.bind("keydown.markItUp",D).bind("keyup",D);e.bind("insertion.markItUp",function(a,b){b.target!==false&&x();d===c.markItUp.focused&&s(b)});e.bind("focus.markItUp",function(){c.markItUp.focused=this})})};c.fn.markItUpRemove=function(){return this.each(function(){var h=c(this).unbind(".markItUp").removeClass("markItUpEditor");h.parent("div").parent("div.markItUp").parent("div").replaceWith(h)})};
c.markItUp=function(h){var l={target:!1};c.extend(l,h);if(l.target)return c(l.target).each(function(){c(this).focus();c(this).trigger("insertion",[l])});c("textarea").trigger("insertion",[l])}})(jQuery);